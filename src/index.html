<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using the UMD build of Chart.js for browser compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; }
        #error-message { display: none; }
        /* Removed conflicting canvas CSS to allow Chart.js to manage responsiveness */
    </style>
</head>
<body class="p-6">

    <!-- Error container -->
    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
        <strong class="font-bold">Dashboard Error:</strong>
        <span class="block sm:inline" id="error-text"></span>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- File Selector -->
        <div class="mb-6">
            <label for="file-selector" class="block text-sm font-medium text-gray-700 mb-2">Select Data File:</label>
            <select id="file-selector" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="indeed-applications.json">indeed-applications.json</option>
                <option value="example.json">example.json</option>
            </select>
        </div>

        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Application Insights</h1>
                <p class="text-gray-500">Visualizing your recent job search activity</p>
            </div>
            <div class="mt-4 md:mt-0 bg-white px-4 py-2 rounded-lg shadow text-sm font-medium text-gray-700">
                Total Applications: <span id="total-count" class="text-blue-600 font-bold text-lg">Loading...</span>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Status Distribution -->
            <div class="card min-w-0">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Application Status</h2>
                <div class="relative h-64 w-full">
                    <canvas id="statusChart"></canvas>
                    <p id="statusChartError" class="hidden absolute inset-0 flex items-center justify-center text-red-500 text-sm">Chart failed to load</p>
                </div>
            </div>

            <!-- Top Locations -->
            <div class="card min-w-0">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Top Locations</h2>
                <div class="relative h-64 w-full">
                    <canvas id="locationChart"></canvas>
                    <p id="locationChartError" class="hidden absolute inset-0 flex items-center justify-center text-red-500 text-sm">Chart failed to load</p>
                </div>
            </div>

            <!-- Top Job Titles -->
            <div class="card md:col-span-2 min-w-0">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Top Job Titles</h2>
                <div class="relative h-64 w-full">
                    <canvas id="titleChart"></canvas>
                    <p id="titleChartError" class="hidden absolute inset-0 flex items-center justify-center text-red-500 text-sm">Chart failed to load</p>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card md:col-span-2 min-w-0">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Daily Application Activity</h2>
                <div class="relative h-80 w-full">
                    <canvas id="timelineChart"></canvas>
                    <p id="timelineChartError" class="hidden absolute inset-0 flex items-center justify-center text-red-500 text-sm">Chart failed to load</p>
                </div>
            </div>

            <!-- Interaction Log -->
            <div class="card md:col-span-2 overflow-hidden min-w-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-700">Application Log</h2>
                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-indigo-600 bg-indigo-200 last:mr-0 mr-1">
                        <span id="interaction-count">0</span> items
                    </span>
                </div>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="filter-date" class="w-full p-2 border border-gray-300 rounded" placeholder="Filter by Date...">
                    <input type="text" id="filter-status" class="w-full p-2 border border-gray-300 rounded" placeholder="Filter by Status...">
                    <input type="text" id="filter-title" class="w-full p-2 border border-gray-300 rounded" placeholder="Filter by Job Title...">
                    <input type="text" id="filter-company" class="w-full p-2 border border-gray-300 rounded" placeholder="Filter by Company...">
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th data-sort="date_applied" class="cursor-pointer px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                <th data-sort="status" class="cursor-pointer px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th data-sort="title" class="cursor-pointer px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Job Title</th>
                                <th data-sort="company" class="cursor-pointer px-5 py-3 border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Company</th>
                            </tr>
                        </thead>
                        <tbody id="interactionTableBody">
                            <!-- Rows inserted via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        console.info("Dashboard script started.");
        Chart.register(ChartDataLabels);

        const fileSelector = document.getElementById('file-selector');
        let chartInstances = {};

        async function fetchData(fileName) {
            try {
                const response = await fetch(`../data/${fileName}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Failed to load application data:", error);
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                errorText.textContent = 'Could not load dashboard data. Please ensure the data file is accessible.';
                errorDiv.style.display = 'block';
                return null;
            }
        }

        function destroyCharts() {
            Object.values(chartInstances).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            chartInstances = {};
        }

        async function updateDashboard(fileName) {
            const rawData = await fetchData(fileName);
            if (!rawData) {
                console.error("Stopping script due to data loading failure.");
                return;
            }

            destroyCharts();

            const applications = rawData.applications;
            let allApplications = [];
            let sortColumn = null;
            let sortDirection = 'asc';

            // Render Table
            if (applications) {
                console.info("Processing applications for table.");
                document.getElementById('total-count').innerText = applications.length;
                allApplications = [...applications].sort((a, b) => new Date(b.date_applied) - new Date(a.date_applied));
                renderTable(allApplications);
            }

            function renderTable(apps) {
                document.getElementById('interaction-count').innerText = apps.length;
                const tableBody = document.getElementById('interactionTableBody');
                if (tableBody) {
                    tableBody.innerHTML = apps.map(app => {
                        let statusClass = "text-gray-900";
                        let statusBg = "bg-gray-100";
                        const status = app.status || "";
                        
                        if (status.includes('viewed')) {
                            statusClass = "text-blue-900";
                            statusBg = "bg-blue-200";
                        } else if (status.includes('Not selected')) {
                            statusClass = "text-red-900";
                            statusBg = "bg-red-200";
                        } else if (status.toLowerCase() === 'applied') {
                            statusClass = "text-green-900";
                            statusBg = "bg-green-200";
                        }
                        return `
                            <tr>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${app.date_applied}</p></td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                    <span class="relative inline-block px-3 py-1 font-semibold leading-tight">
                                        <span aria-hidden class="absolute inset-0 ${statusBg} opacity-50 rounded-full"></span>
                                        <span class="relative ${statusClass}">${status}</span>
                                    </span>
                                </td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap font-medium">${app.title}</p></td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm"><p class="text-gray-900 whitespace-no-wrap">${app.company}</p></td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            function applyFiltersAndSort() {
                const filterDate = document.getElementById('filter-date').value.toLowerCase();
                const filterStatus = document.getElementById('filter-status').value.toLowerCase();
                const filterTitle = document.getElementById('filter-title').value.toLowerCase();
                const filterCompany = document.getElementById('filter-company').value.toLowerCase();
                let filteredApps = allApplications.filter(app => {
                    return (app.date_applied || '').toLowerCase().includes(filterDate) &&
                           (app.status || '').toLowerCase().includes(filterStatus) &&
                           (app.title || '').toLowerCase().includes(filterTitle) &&
                           (app.company || '').toLowerCase().includes(filterCompany);
                });
                if (sortColumn) {
                    filteredApps.sort((a, b) => {
                        const aValue = a[sortColumn];
                        const bValue = b[sortColumn];
                        if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                        if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                renderTable(filteredApps);
            }

            document.getElementById('filter-date').addEventListener('input', applyFiltersAndSort);
            document.getElementById('filter-status').addEventListener('input', applyFiltersAndSort);
            document.getElementById('filter-title').addEventListener('input', applyFiltersAndSort);
            document.getElementById('filter-company').addEventListener('input', applyFiltersAndSort);
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const newSortColumn = header.getAttribute('data-sort');
                    if (sortColumn === newSortColumn) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = newSortColumn;
                        sortDirection = 'asc';
                    }
                    applyFiltersAndSort();
                });
            });

            // Chart Logic
            try {
                if (typeof Chart === 'undefined') throw new Error("Chart.js library not loaded");
                const statusCounts = applications.reduce((acc, app) => {
                    const status = app.status || "Unknown";
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});
                const locationCounts = applications.reduce((acc, app) => {
                    const loc = app.location || "Unknown";
                    acc[loc] = (acc[loc] || 0) + 1;
                    return acc;
                }, {});
                const topLocations = Object.entries(locationCounts).sort(([,a],[,b]) => b-a).slice(0,5).map(([k])=>k);
                const topLocationCounts = Object.entries(locationCounts).sort(([,a],[,b]) => b-a).slice(0,5).map(([,v])=>v);
                const titleCounts = applications.reduce((acc, app) => {
                    const title = app.title || "Unknown";
                    acc[title] = (acc[title] || 0) + 1;
                    return acc;
                }, {});
                const topTitles = Object.entries(titleCounts).sort(([,a],[,b]) => b-a).slice(0,5).map(([k])=>k);
                const topTitleCounts = Object.entries(titleCounts).sort(([,a],[,b]) => b-a).slice(0,5).map(([,v])=>v);
                const timelineCounts = applications.reduce((acc, app) => {
                    if (app.date_applied) {
                        const date = app.date_applied;
                        acc[date] = (acc[date] || 0) + 1;
                    }
                    return acc;
                }, {});
                const sortedDates = Object.keys(timelineCounts).sort((a, b) => new Date(a) - new Date(b));
                const timelineData = sortedDates.map(date => timelineCounts[date]);

                // Initialize Charts
                chartInstances.statusChart = new Chart(document.getElementById('statusChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#6b7280'], borderWidth: 1 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12 } }, tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw} (${((context.raw / context.chart.getDatasetMeta(0).total) * 100).toFixed(2)}%)` } }, datalabels: { formatter: (value, ctx) => `${(value*100 / ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0)).toFixed(2)}%`, color: '#fff' } } },
                    plugins: [ChartDataLabels],
                });
                chartInstances.locationChart = new Chart(document.getElementById('locationChart'), {
                    type: 'bar',
                    data: { labels: topLocations, datasets: [{ label: 'Applications', data: topLocationCounts, backgroundColor: '#8b5cf6', borderRadius: 4 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { display: false } }, y: { grid: { display: false } } } }
                });
                chartInstances.titleChart = new Chart(document.getElementById('titleChart'), {
                    type: 'bar',
                    data: { labels: topTitles, datasets: [{ label: 'Applications', data: topTitleCounts, backgroundColor: '#14b8a6', borderRadius: 4 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { display: false } }, y: { grid: { display: false } } } }
                });
                chartInstances.timelineChart = new Chart(document.getElementById('timelineChart'), {
                    type: 'line',
                    data: { labels: sortedDates, datasets: [{ label: 'Applications per Day', data: timelineData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { intersect: false, mode: 'index' } } }
                });

            } catch (e) {
                console.error("Chart Render Error:", e);
                ['statusChartError', 'locationChartError', 'titleChartError', 'timelineChartError'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden');
                });
            }
        }

        fileSelector.addEventListener('change', (event) => {
            updateDashboard(event.target.value);
        });

        // Initial load
        updateDashboard(fileSelector.value);
    });
    </script>
</body>
</html>